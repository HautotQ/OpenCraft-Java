name: Compiler OpenCraft en site Web (TeaVM)

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Cloner le dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: â˜• Installer Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ğŸ”§ Installer Maven
        run: sudo apt-get install -y maven

      - name: ğŸ§± Compiler le projet Maven
        run: mvn -B clean package --file pom.xml

      - name: ğŸŒ Ajouter le plugin TeaVM
        run: |
          mkdir -p src/main/resources
          mkdir -p target/teavm-output
          echo '
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                                       http://maven.apache.org/xsd/maven-4.0.0.xsd">
              <modelVersion>4.0.0</modelVersion>
              <groupId>net.tabarcraft.opencraft</groupId>
              <artifactId>OpenCraft-Web</artifactId>
              <version>1.0</version>
              <build>
                  <plugins>
                      <plugin>
                          <groupId>org.teavm</groupId>
                          <artifactId>teavm-maven-plugin</artifactId>
                          <version>0.9.2</version>
                          <executions>
                              <execution>
                                  <phase>package</phase>
                                  <goals>
                                      <goal>build</goal>
                                  </goals>
                              </execution>
                          </executions>
                          <configuration>
                              <targetDirectory>target/teavm-output</targetDirectory>
                              <mainClass>net.tabarcraft.opencraft.Launcher</mainClass>
                              <targetType>WEBASSEMBLY</targetType>
                              <minifying>false</minifying>
                          </configuration>
                      </plugin>
                  </plugins>
              </build>
          </project>' > teavm-pom.xml
          mvn -f teavm-pom.xml package

      - name: ğŸ§¾ CrÃ©er un index.html minimal
        run: |
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>OpenCraft Web</title></head><body><script src='classes.js'></script></body></html>" > target/teavm-output/index.html

      - name: ğŸš€ DÃ©ployer sur GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/teavm-output
